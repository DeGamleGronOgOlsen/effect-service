@page "/effect/create/auction/{effectId:guid?}"
@model auctionServiceAPI.Pages.Effects.CreateAuctionFromEffectModel
@{
    ViewData["Title"] = "Opret Auktion";
}
<head>
    <link rel="stylesheet" href="/css/effect/CreateAuction.css">
</head>
<div class="container mt-4">
    <h1>Opret Auktion fra Effekt</h1>
    
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">
            @Model.ErrorMessage
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Effekt Detaljer</h4>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Effect?.Image))
                    {
                        <img src="@Model.Effect.Image" alt="@Model.Effect.Title" class="img-fluid mb-3" style="max-height: 200px; object-fit: contain;">
                    }
                    <div>
                        <strong>Titel:</strong> @Model.Effect?.Title
                    </div>
                    <div>
                        <strong>Beskrivelse:</strong> @Model.Effect?.Description
                    </div>
                    <div>
                        <strong>Minimumspris:</strong> @Model.Effect?.MinimumPrice kr.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>Udfyld Auktions Detaljer</h4>
                </div>
                <div class="card-body">
                    <!-- Vigtigst: form-metoden er POST -->
                    <form method="post" action="/auction" enctype="multipart/form-data">
                        <input type="hidden" name="AuctionId" value="@Model.AuctionToCreate.AuctionId" />
                        <input type="hidden" name="AuctionTitle" value="@Model.AuctionToCreate.AuctionTitle" />
                        <input type="hidden" name="Description" value="@Model.AuctionToCreate.Description" />
                        <input type="hidden" name="Image" value="@Model.AuctionToCreate.Image" />
                        <input type="hidden" name="AuctionStatus" value="@Model.AuctionToCreate.AuctionStatus"/>
                        <input type="hidden" name="MinimumPrice" value="@Model.AuctionToCreate.MinimumPrice" />
                        <input type="hidden" name="EffectId" value="@Model.AuctionToCreate.EffectId" />
                        <input type="hidden" name="AppraisalId" value="@Model.AuctionToCreate.AppraisalId" />
                        <input type="hidden" name="UserId" value="@Model.AuctionToCreate.UserId" />
                        
                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="AuctionToCreate.StartDate">Start Dato</label>
                                <input name="StartDate" value="@Model.AuctionToCreate.StartDate" type="datetime-local" class="form-control" required />
                                <span asp-validation-for="AuctionToCreate.StartDate" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="AuctionToCreate.EndDate">Slut Dato</label>
                                <input name="EndDate" value="@Model.AuctionToCreate.EndDate" type="datetime-local" class="form-control" required />
                                <span asp-validation-for="AuctionToCreate.EndDate" class="text-danger"></span>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label asp-for="AuctionToCreate.Location">Lokation</label>
                            <input name="Location" value="@Model.AuctionToCreate.Location" class="form-control" required />
                            <span asp-validation-for="AuctionToCreate.Location" class="text-danger"></span>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label asp-for="AuctionToCreate.Category">Kategori</label>
                            <select name="Category" value="@Model.AuctionToCreate.Category" class="form-control" required>
                                <option value="">-- Vælg Kategori --</option>
                                <option value="0">Møbler</option>
                                <option value="1">Porcelæn</option>
                                <option value="2">Smykker</option>
                                <option value="3">Kunst</option>
                                <option value="4">Sølvtøj</option>
                                <option value="5">Antikviteter</option>
                            </select>
                            <span asp-validation-for="@Model.AuctionToCreate.Category" class="text-danger"></span>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label asp-for="AuctionToCreate.StartingPrice">Startpris (kr.)</label>
                            <input name="StartingPrice" value="@Model.AuctionToCreate.StartingPrice" class="form-control" type="number" step="0.01" required />
                            <span asp-validation-for="AuctionToCreate.StartingPrice" class="text-danger"></span>
                        </div>
                        
                        <div class="mt-4">
                            <button onclick="transferToAuction()" type="submit" class="btn btn-primary">Opret Auktion</button>
                            <a href="/effect/all" class="btn btn-secondary">Annuller</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script> async function transferToAuction() {
        const effectId = '@Model.EffectId';

        try {
            const response = await fetch(`/effect/${effectId}/transfer-to-auction`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                alert("Effekt blev overført til auktion.");
                window.location.href = "/effect/all"; // redirect hvis du vil
            } else {
                const errorText = await response.text();
                alert("Fejl ved overførsel: " + errorText);
            }
        } catch (err) {
            alert("Netværksfejl: " + err);
        }   
    }

    // Set minimum values for dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const startDateInput = document.querySelector('input[asp-for="AuctionToCreate.StartDate"]');
    const endDateInput = document.querySelector('input[asp-for="AuctionToCreate.EndDate"]');
    
    
    // Format date to YYYY-MM-DDThh:mm
    const formatDateForInput = (date) => {
        return date.toISOString().slice(0, 16);
    };
    
    // Set min dates if inputs exist
    if (startDateInput) {
        startDateInput.min = formatDateForInput(today);
        
        // Update end date min when start date changes
        startDateInput.addEventListener('change', function() {
            if (endDateInput) {
                const startDate = new Date(this.value);
                endDateInput.min = formatDateForInput(startDate);
                
                // If end date is before start date, update it
                const endDate = new Date(endDateInput.value);
                if (endDate < startDate) {
                    endDateInput.value = formatDateForInput(startDate);
                }
            }
        });
    }
});
</script>